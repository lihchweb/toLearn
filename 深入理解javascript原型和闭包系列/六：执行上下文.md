
执行上下文也叫执行上下文环境。

‘准备阶段’也称为 ‘预解析’。

从三段代码来看:

```js
console.log(a) //报错
//Uncaught ReferenceError: a is not defined
```

```js
console.log(a) //undefind
var a;
```

```js
console.log(a);//undefined
var a = 10;
```

为什么会出现上述现象，可以猜测js在执行之前，是做了一些准备工作的。

事实上在js代码真正一行一行开始执行之前，浏览器会进行一些准备工作。包括对变量的声明，而变量的赋值才是在执行阶段进行的。

### 1. 情况1

![image](https://user-images.githubusercontent.com/24636279/120577121-712df180-c456-11eb-9f2c-716f777fc013.png)


### 2. 情况2

![image](https://user-images.githubusercontent.com/24636279/120577677-38424c80-c457-11eb-9843-99f5bc76752b.png)

**为什么可以打印出结果呢？ this是个关键字，在“准备工作”阶段，this直接被赋值了。**

### 3. 情况3

```js
console.log(f1) //function f1 () {}
function f1() {} //函数声明

console.log(f2) //undefined
var f2 = function () {} //函数表达式
```


**在“准备工作”中，对函数表达式来说，只会进行变量提升，只是声明变量f2, 对于函数声明来说，直接给函数赋值了。**


在"准备工作" 阶段，完成了以下工作:
 - **变量、函数表达式的-----变量声明，默认赋值为undefined**
 - **this的----------------赋值**
 - **函数声明的-------------赋值**

**这三种数据的准备情况我们称之为‘执行上下文’或‘执行上下文环境’。**

上面的3种情况都是在全局环境下执行的。

JavaScript在执行每段代码之前，都会进行这些‘准备工作’来生成执行上下文。

**而代码段又分为三种情况：全局代码，函数体，eval代码。**

> 所谓‘代码段’就是一段文本形式的代码。（可以这么理解)

#### 1.全局代码

```js
<script type="text/javascript">
  //代码段....
</script>
```

#### 2.eval代码

```js
eval('alert(123)')
```
eval接受的也是一段文本形式的代码

#### 3.函数体

```js
function fn(x) {
  console.log(x + 5);
}

//相当于

var fn = new Function('x', 'console.log(x + 5)');
```

函数体为什么是代码段呢，因为函数在创建时，本质上是通过new Function()得到的。其中需要传入文本形式的参数作为函数体。


eval不常用，也不推荐使用。

---

上面列出了代码执行时的三种情况，但是如果在函数中，还存在其他的数据时：

![image](https://user-images.githubusercontent.com/24636279/120580593-07b0e180-c45c-11eb-9133-aff142d05720.png)

上图表明了在函数体的语句执行之前，arguments变量和函数的参数都已经被赋值了。

> 感受不到这两个参数在语句执行之前被赋值。

**函数每被调用一次，都会产生一个新的执行上下文环境。 因为不同的函数调用可能会有不同的参数。**

**函数在定义的时候，就已经确定了函数体内部自由变量的作用域**

如下代码:

```js
var a = 10;
function fn() {
 console.log(a); //a就是个自由变量
}

function bar(f) {
 var a = 20;
 fn();
}
 
bar(fn); //打印10， 而非20
```


总结: 


|情形 |操作 |
|--- |--- |
| 普通变量（包括函数表达式）  | 声明（默认赋值为undefined） |
| 函数声明  | 赋值 |
| this  | 赋值 |

如果代码段是函数体的话，还要加上

|情形 |操作 |
|--- |--- |
|参数|赋值|
|arguments| 赋值|
|自由变量的取值作用域|赋值|


> 在执行js代码时，会有数不清的函数调用，会产生许多上下文环境，这么多上下文环境如何管理，如何销毁释放内存? 这就需要 ‘执行上下文栈’来解释了。
