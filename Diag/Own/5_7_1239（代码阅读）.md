# 问题集

## 5/7问题

一些js文件

- LibCmnUtil.js
- DiagCmnSimpRun.js
- DiagCmnPaperSupply.js
- DiagCmnSimpAlert.js
- DiagCommon.js
- DeviceSupport.js

---

- [x] `asLibCfg.pl` 里的 `DIAG_DC1239_MEDIA_SIZE`的值： `[10, 80, 11, 89]`
- [x] run画面的相关操作
- [x] .cscwCall(“status”, status)：切换xx的状态。.cscwCall('status')：获取xx的状态
- [x] `appCr`里逻辑处理。其中需要 `top.Cmn.FrmDelMsg()`来清除`msg`,**否则，进入别的frm信息还在。**
- [x] `CscWidget`: 它的默认options,jvos里可改写，js里build之前改写。`DeviceSupport.js, DiagCommon.js`，
- [x] FF:查看机型是否支持机能
- [x] `top.Cmn.FrmSetIndProc('FRM', PaperSupplyTableRow.diagCmnPaperSupplyEvt), DiagCmnPaperSupply, DiagCmnPaperSupplySetup, diagCmnPaperSupplyEvt,`函数。查看`DiagCmnPaperSupply.js`的`DiagCmnPaperSupply`对象属性和方法。
- [x] `top.Cmn.KeySetCasualProc('KEY_MENU', new top.Cmn.UiActionProc(DiagCommonHandleHomeKeyTapped, null))`: 禁用home按键事件
- [x] `DiagCommonRegistButton('DC1239_Start_Btn', appOKCond, appOKNotify, true, 'LEAVEFRAME');`
- [x] `DiagCommonRegistToggleSwitch('DC1239_Option1_TblR', 'DC1239_Option1_TSw', dc1239ToggleSwitch)`里 `dc1239ToggleSwitch`函数：每次切换时重新设置值
- [x] `DiagCommonCallOption('DC1239_Option1_TSw', 'status', usrDat.toggle)`:对switch状态进行设置，否则页面无法保持switch状态。调用实例的方法，对key设定value。只传前两个参数，则用于获取值。
- [x] `ASGETIOT`: 获取tray 1- 4的信息，手插tray获取不到。 pageSz的满足条件
- [x] clear, scan 类型DADF 1239发的job
- [x] MID：事件唯一标识，watch里查看MID。发一个job，就产生一个MID。在页面log有显示，但是页面log里显示的是上一个job的名称。



> 10.87.64.93



>  DC1239Test_vos.js`在`:\APP\Apache24\htdocs\uilcw_dev\lui\rc\wsvga\DC1239Test_vos.js`里



### run画面相关操作

AS → Diag **→** 从控制台看MID，选择对应的选项 → 弹出frame → 设置job动作  → send

## widgets位置

- `LibViewUtilRegRestoreWidgets`
- `LibViewUtilExecRestoreWidgets`

以上两个函数一般配合使用。appCr先调用第一个函数。设置完usrDat，并且初始化组件之后，在调用第二个函数。

其中`widgetList: cscw-scrollPane,.cscw-table,.cscw-grid,.cscw-iconSelector,.cscw-popup,.cscw-alert`

## `top.Cmn.FrmGetMsg`方法

- 该方法获取到一个`FrmMsgPkg`对象值，包含两个key
  - From: 来自那个frm
  - Msg: `Fs,FsMM, Gsm, Ss, SsMM,Sz, tp,smh对象, tray`等字段。其中：
    - `smh: {Tp: '', Sz: '', Fs:'', Ss: '', Gsm: ''}`



- [ ] 弄明白Msg里各个参数的含义。



## `FrmMgr.js`的路由控制

- `FrmCloseFrm(msg)`: 关闭当前frame, msg给parent frame传值
- `FrmOpenFrm(frmId, msg, alias)`: 打开指定frame，并给其传值msg, alias设置frm别名
- `FrmChgFrm(frmId, msg)`： 改变活跃的frame画面。**开run画面时，需要用到此函数**



```javascript
//当前有frm正在加载?则把要关闭的回调放回要给队列内
//否则直接关闭。
function FrmCloseFrm(msg) {
  if(FpWaitOnLd){ //FpWaitOnLd没搜到
    FrmCgiQueue.push( function(){ FrmCloseFrmBind(msg); } );      
  }else{
    return FrmCloseFrmBind(msg);
  }  
}

//关闭动作，对传递的信息做处理
function FrmCloseFrmBind(msg) {
  var dspInfo = frmLibGetDspInfo();

  if (typeof msg != "undefined") {
    if (typeof FrmMsgTbl[dspInfo.NextFrmBase] != "object") {
      FrmMsgTbl[dspInfo.NextFrmBase] = new Object();
    }
    var msgPkg = (msg != null) ? new FrmMsgPkg(dspInfo.CrntFrmId,msg) : null;
    FrmMsgTbl[dspInfo.NextFrmBase][dspInfo.NextFrmId] = msgPkg;
  }

  if (FrmBaseIsLoading) {
    FrmExecChgHtmInBase = true;
  }

  FrmCrntCGIInfo = {Cmd:"CLSFRM", Base:dspInfo.CrntFrmBase, Crnt:dspInfo.CrntFrmId, Alias:null, Msg:msg};
  var prm = "BASE="+dspInfo.CrntFrmBase+FRM_CGI_DELIMITER+"CRNT="+dspInfo.CrntFrmId+FRM_CGI_DELIMITER+"ALIAS="+FRM_CGI_DELIMITER;
  frmReq("closeFrm.cgi",prm);
  return 0;
}
```



## `DiagCommonRegistButton`方法

```javascript
DiagCommonRegistPopupButtonLeft('DC1239_Top_Hdr', appClsCond, appClsNotify, true, 'LEAVEFRAME');

function appClsCond () {
  var deferred = new $.Deferred();
  top.As.AsReqDiagSiqaControl('EXIT', null, null, new top.As.AsCallBack(DiagCommonJobCb, [deferred,'AsGetDiagRslt']));
  return deferred.promise();
}
function appClsNotify () {
  top.Cmn.FrmCloseFrm();
}
//top.As.AsReqDiagSiqaControl用到 AsDiag.js 里的方法
//方法返回数据可在AsDiagSiqaControl.cgi里设置
```



- 为按钮注册事件，含五个参数：`id, condFuc, notifyFuc, soundEnable, ignoreControl`
  - `id`:  注册元素id
  - `condFuc`:  事件发生时的响应
  - `notifyFuc`： 上面函数为成功状态时执行。在这里关闭active frame。
  - `soundEnable`:  当`condFnc`为null，则为false,否则值为true，此时禁止按钮默认音。
  - `ignoreControl`： 连打控制。事件绑定函数时要传的参数值如下：
    - `NONE`： 允许双击 double click，无 job 发送，也没有画面迁移时
    - `LEAVEFRAME`: 打开/关闭frame，画面迁移时，连打处理。
    - `STAYFRAME`： 有 job 发送，但没有画面迁移时



### 关于`soundEnable`的详细说明：

- 有condFuc:
  -  禁止默认音（Bi)
     - false： 一直没声
     - true，condFuc为：
       - OK Bi一声（OK音）
       - NG Duang一声（NG音）
  -  不禁止默认音：
     - false，condFuc为：
       - OK时 Bi一声（OK音）
       - NG时 Bi一声 （NG音）
     - true，condFuc为：
       - OK时 Bi两声（OK音）
       - NG时 Bi一声(OK音)，Duang一声（NG音)
- 无condFuc：
  - 禁止默认音
    - false，一直没声
    - true，Bi一声
  - 不禁默认音
    - false：Bi一声
    - true：Bi两声

> 事件绑定函数，没有cond函数时（即不需要提示NG音），第四个参数设为false，不需要禁默认音
> 事件绑定函数，有cond函数时（即需要提示NG音），第四个参数必须设为true，需要禁默认音

## `DiagCommonRegistButton`方法

```javascript
DiagCommonRegistButton('DC1239_Start_Btn', appOKCond, appOKNotify, true, 'LEAVEFRAME');

function appOKCond () {
  var deferred = new $.Deferred();
  var toggleSts = DiagCommonCallOption('DC1239_Option1_TSw', 'status');//获取按钮状态

  if (toggleSts === 'on') {
    dc1239HandleSmplPrt(deferred);
  } else {
    return deferred.resolve();
  }
  return deferred.promise();
}

function appOKNotify () {
  var toggleSts = DiagCommonCallOption('DC1239_Option1_TSw', 'status');
  var tray = PaperSupplyTableRow.diagCmnPaperSupplyGetCurrentData().tray;
  var smh = PaperSupplyTableRow.diagCmnPaperSupplyGetCurrentData().smh;
  var usrDat = top.Cmn.FrmGetUsrDat();
  usrDat.tray = tray;
  usrDat.smh = smh;
  top.Cmn.FrmSetUsrDat(usrDat);

  var ctx = {};
  ctx.actionType = 'DC1239_SMPLPRT';

  if (toggleSts === 'on') {
    top.Cmn.FrmOpenFrm('DiagCmnSimpRun_frm', ctx);
  } else {
    top.Cmn.FrmOpenFrm('DC1239Load_frm');
  }
}

function dc1239HandleSmplPrt (deferred) {
  var asPrt = top.As.AsGetDiagSmplPrt('Prt');//asGetDiagObj: {Tp: ''} 
  asPrt.Tp = 'SP_ST';
  top.As.AsSetDiagSmplPrt('Prt', asPrt);//设置打印机Tp参数
  //设置tray，手插tray状
  var curData = PaperSupplyTableRow.diagCmnPaperSupplyGetCurrentData();
  var trayTp = curData.tray.Tp;
  var asIot = top.As.AsGetIOT(PaperSupplyTableRow.diagCmnPaperSupplyGetTrayIOT(trayTp));
  var asSMH = curData.smh;
  var papSize = asIot.Sz;
  top.As.AsSetDiagSmplPrt('Tray', curData.tray);
  top.As.AsSetDiagSmplPrt('SMH', asSMH);
  //手插tray,设置一下papSize
  if (trayTp === 'SMH') {
    papSize = asSMH.Sz;
  }
  var papSzFlag = true;
  //禁则
  papSzFlag = top.Cmn.LibGetDiagChkSz(papSize, 'DIAG_DC1239_MEDIA_SIZE');

  if (!papSzFlag) {
    top.Msg.MsgDsp('KAE9191_stx');
    return deferred.reject();
  } else {//不符合禁则，发起job
    top.As.AsReqDiagSmplPrt(new top.As.AsCallBack(DiagCommonJobCb,
      [deferred, 'AsGetDiagRslt', 'AsGetDiagSmplPrt', {name: 'DC1239'}]));
  }
}
```

- 点击确认时，执行`appOKCond`, 此时它获取switch开关状态，如果：
  - 状态为`on`，执行`dc1239HandleSmplPrt`函数，设置打印机状态
  - 状态为`off`，什么也不做，返回`deferred.resolve()`对象。如果此处返回`deferred.reject`，终止流程，并且有错误音。
- 执行`appOKNotify`函数:  设置usrDat, 根据开关状态
  - 状态为`on`，执行`top.Cmn.FrmOpenFrm('DiagCmnSimpRun_frm', ctx)`
  - 状态为`off`,打开1239load画面 `top.Cmn.FrmOpenFrm('DC1239Load_frm')`
- 先返回该deferred.promise() 异步对象，而后根据deferred对象状态进行后续回调。



## `FrmSetIndProc`方法

```javascript
PaperSupplyTableRow.diagCmnPaperSupplySetup(); //注释掉无法获取用纸选择里数据
top.Cmn.FrmSetIndProc('FRM', PaperSupplyTableRow.diagCmnPaperSupplyEvt);//给frm设置事件

//diagCmnPaperSupplyEvt
diagCmnPaperSupplyEvt: function(uiEvt) {
    switch (uiEvt.Data.Mid) {
        case 'M_IOT':
            var pid = top.Cmn.LibCmnFindTbl(diagDefaultTraysInfo, this.state.trayName, 'tray', 'pid');

            for (var i = 0; i < uiEvt.Data.Pid.length; i++) {
                if (pid !== uiEvt.Data.Pid[i]) { // Just handle current tray
                    continue;
                }
                this.diagCmnPaperSupplyUpdateTray(uiEvt.Data.Pid[i]);
            }

            if (typeof this.usrDefEvtHandle === 'function') {
                this.usrDefEvtHandle();
            }
            break;
        default:
            break;
    }
}
```

> 一种事件是用户点击UI界面产生的事件，另外一种事件是从机器底层发出的事件。
>
> 比如：用纸选择，我们可以通过UI界面手动选择tray信息，当然也可以直接从打印机上直接操作，此时会从底层发送event过来，用FrmSetIndProc就可以将发生event的影响返回一个结果。
>
> 目前diag项目应用场景有两个： 1. 开启run画面；2. 使用用纸选择feature时。

## 事件

- 普通控件： `DiagCommonRegistButton `
- 头部控件：` DiagCommonRegistPopupButtonLeft `
- 页面上： `top.Cmn.FrmSetIndProc("FRM", diagSimpRunRcvEvt)`



> 改了.pl，json文件时，要刷新，否则数据不更新

